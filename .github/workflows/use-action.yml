name: Example Workflow using Image Tag Updater

on:
  workflow_dispatch:
    inputs:
      run:
        description: 'workflow run'
        required: true
        default: 'true'
  workflow_run:
    workflows: ["Generate changelog"]  
    types:
      - completed

permissions:
  contents: write

jobs:
  test-local:
    name: Run Local Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.14'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run tests
        run: python3 tests/test_local.py

  action-module-matrix-test:
    name: Matrix Test
    needs: test-local
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Single File Update"
            target_values_file: "dev1.values.yaml"
            file_pattern: ""
            dry_run: "false"
            debug: "false"
            branch: "test-single-file"

          # - name: "Pattern Match Update"
          #   target_values_file: ""
          #   file_pattern: "dev*.values.yaml"
          #   dry_run: "false"
          #   debug: "false"
          #   branch: "test-pattern-match"

          - name: "Dry Run Single File"
            target_values_file: "dev2.values.yaml"
            file_pattern: ""
            dry_run: "true"
            debug: "true"
            branch: "main"

          - name: "Dry Run Pattern Match"
            target_values_file: ""
            file_pattern: "dev*.values.yaml"
            dry_run: "true"
            debug: "false"
            branch: "main"

          # - name: "Debug Mode Single File"
          #   target_values_file: "dev2.values.yaml"
          #   file_pattern: ""
          #   dry_run: "false"
          #   debug: "true"
          #   branch: "test-debug-single"

          - name: "Debug Mode Pattern Match"
            target_values_file: ""
            file_pattern: "dev*.values.yaml"
            dry_run: "false"
            debug: "true"
            branch: "test-debug-pattern"

          - name: "Tag Format Validation Test"
            target_values_file: "dev1.values.yaml"
            file_pattern: ""
            tag_string: "tag"
            new_tag: "v1.0.0-valid"
            dry_run: "true"
            debug: "true"
            branch: "main"
            
          - name: "Tag String Validation Test"
            target_values_file: "dev1.values.yaml"
            file_pattern: ""
            tag_string: "tag"
            new_tag: "v1.0.0"
            dry_run: "true"
            debug: "true"
            branch: "main"

          - name: "Invalid Tag Format Test (Expected to Fail)"
            target_values_file: "dev1.values.yaml"
            file_pattern: ""
            tag_string: "tag"
            new_tag: "@invalid@tag"
            continue_on_error: true
            dry_run: "true"
            debug: "true"
            branch: "main"

          - name: "Tag Prefix Test"
            target_values_file: "dev1.values.yaml"
            file_pattern: ""
            tag_string: "tag"
            new_tag: "1.2.3"
            tag_prefix: "v"
            dry_run: "true"
            debug: "true"
            branch: "main"

          - name: "Tag Suffix Test"
            target_values_file: "dev1.values.yaml"
            file_pattern: ""
            tag_string: "tag"
            new_tag: "latest"
            tag_suffix: "-prod"
            dry_run: "true"
            debug: "true"
            branch: "main"

          - name: "Tag Prefix and Suffix Test"
            target_values_file: "dev1.values.yaml"
            file_pattern: ""
            tag_string: "tag"
            new_tag: "1.2.3"
            tag_prefix: "release-"
            tag_suffix: "-staging"
            dry_run: "true"
            debug: "true"
            branch: "main"

          - name: "Conditional Update - update_if_contains"
            target_values_file: "dev1.values.yaml"
            file_pattern: ""
            tag_string: "tag"
            new_tag: "v2.0.0"
            update_if_contains: "327"
            dry_run: "true"
            debug: "true"
            branch: "main"

          - name: "Conditional Update - skip_if_contains"
            target_values_file: "dev1.values.yaml"
            file_pattern: ""
            tag_string: "tag"
            new_tag: "v2.0.0"
            skip_if_contains: "999"
            dry_run: "true"
            debug: "true"
            branch: "main"

          - name: "Summary File Test"
            target_values_file: "dev1.values.yaml"
            file_pattern: ""
            tag_string: "tag"
            new_tag: "v1.2.3"
            summary_file: ".github/test-updates.json"
            dry_run: "true"
            debug: "true"
            branch: "main"

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 10

      - name: Configure Git Safe Directory
        run: git config --global --add safe.directory ${{ github.workspace }}

      - name: Set short sha
        id: vars
        run: |
          echo "short_sha=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: ${{ matrix.name }}
        id: update-tag
        uses: ./
        continue-on-error: ${{ matrix.continue_on_error || false }}
        with:
          target_path: charts/somaz/api
          target_values_file: ${{ matrix.target_values_file }}
          file_pattern: ${{ matrix.file_pattern }}
          new_tag: ${{ matrix.new_tag || steps.vars.outputs.short_sha }}
          branch: ${{ matrix.branch }}
          github_token: ${{ secrets.PAT }}
          git_user_name: GitHub Actions
          git_user_email: actions@github.com
          repo: somaz94/image-tag-updater
          tag_string: ${{ matrix.tag_string || 'tag' }}
          tag_prefix: ${{ matrix.tag_prefix || '' }}
          tag_suffix: ${{ matrix.tag_suffix || '' }}
          update_if_contains: ${{ matrix.update_if_contains || '' }}
          skip_if_contains: ${{ matrix.skip_if_contains || '' }}
          summary_file: ${{ matrix.summary_file || '' }}
          dry_run: ${{ matrix.dry_run }}
          debug: ${{ matrix.debug }}

      - name: Display Outputs
        if: always()
        run: |
          echo "Files Updated: ${{ steps.update-tag.outputs.files_updated }}"
          echo "Updated Files: ${{ steps.update-tag.outputs.updated_files }}"
          echo "Old Tags: ${{ steps.update-tag.outputs.old_tags }}"
          echo "New Tag Applied: ${{ steps.update-tag.outputs.new_tag_applied }}"
          echo "Changes Made: ${{ steps.update-tag.outputs.changes_made }}"
          echo "Commit SHA: ${{ steps.update-tag.outputs.commit_sha_short }}"
          echo "Full Commit SHA: ${{ steps.update-tag.outputs.commit_sha }}"
